<!DOCTYPE html>
<html lang="zh-hant">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CKEditor 5 jQuery 範例</title>
<!-- 引入 CKEditor 5 的 CDN 鏈接 -->
<script
	src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
<!-- 引入 jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
	<h1>CKEditor 5 jQuery 範例</h1>

	<!-- 編輯器容器 -->
	<div id="editor"></div>
	<!-- 提交按鈕 -->
	<button id="submitButton">提交</button>



	<!-- 隱藏的表單，用於提交編輯器的內容 -->
	<form id="editorForm" action="YourServletURL" method="post"
		style="display: none;">
		<textarea id="editorContent" name="editorContent"></textarea>
	</form>



	<script>
	
	const contextPath = window.location.pathname.split('/')[1];
    // 使用Servlet的URL，並在前面加上專案的上下文路徑
    const servletUrl = `/${contextPath}/UploadServlet`;
	
    class MyUploadAdapter {
        constructor(loader) {
            this.loader = loader;
        }

        upload() {
            return this.loader.file
                .then(file => new Promise((resolve, reject) => {
                    this._initRequest();
                    this._initListeners(resolve, reject, file);
                    this._sendRequest(file);
                }));
        }

        abort() {
            if (this.xhr) {
                this.xhr.abort();
            }
        }

        _initRequest() {
            const xhr = this.xhr = new XMLHttpRequest();
            xhr.open('POST', servletUrl, true);
            xhr.responseType = 'arraybuffer';
        }

        _xhrListeners(resolve, reject, file) {
            const xhr = this.xhr;
            const loader = this.loader;
            const genericErrorText = `Couldn't upload file: ${file.name}.`;

            xhr.addEventListener('error', () => reject(genericErrorText));
            xhr.addEventListener('abort', () => reject());
            xhr.addEventListener('load', () => {
                const response = xhr.response;

                if (!response || response.error) {
                    return reject(response && response.error ? response.error.message : genericErrorText);
                }

                // 將接收到的 ArrayBuffer 資料轉換為 Blob
                const blob = new Blob([response], { type: 'image/jpeg' });

                // 將 Blob 資料轉換為 Data URL
                const reader = new FileReader();
                reader.onloadend = function () {
                    // reader.result 包含 Data URL 資料，可以用於顯示圖片
                    resolve({
                        default: reader.result
                    });
                };
                reader.readAsDataURL(blob);
            });

            // ...（之後的代碼）
        }

        _sendRequest(file) {
            const data = new FormData();
            data.append('file', file);

            this.xhr.send(data);
        }
    }

    function SimpleUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
            return new MyUploadAdapter(loader);
        };
    }

    ClassicEditor
        .create(document.querySelector('#editor'), {
            extraPlugins: [SimpleUploadAdapterPlugin],
        })
        .then(editor => {
            // Simulate label behavior if textarea had a label
            if (editor.sourceElement.labels.length > 0) {
                editor.sourceElement.labels[0].addEventListener('click', e => editor.editing.view.focus());
            }
        })
        .catch(error => {
            console.error();
        });
</script>
</body>

</html>
